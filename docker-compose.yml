version: '3.8'

services:
  # ------------------------------------
  # 1. Django DRF backend
  # ------------------------------------
  backend:
    build:
      context: ./services
      dockerfile: Dockerfile.dev
    container_name: django_backend
    # Starting the Django development server (with hot reload enabled)
    command: python /app/manage.py runserver 0.0.0.0:8000
    volumes:
      # Mount the host PC's code to /app/src inside the container
      - ./services:/app
    ports:
      - "8000:8000"
    env_file:
      - ./.env
    depends_on:
      - redis # Depends on Redis as the Celery broker

  # ------------------------------------
  # 2. Vite-Vue frontend
  # ------------------------------------
  frontend:
    build:
      context: ./accounts
      dockerfile: Dockerfile.dev
    container_name: vue_frontend
    # Starting the Vue development server
    command: npm run dev -- --host 0.0.0.0
    volumes:
      # Mount the host PC's code to /app inside the container
      - ./accounts:/app
      # Speeding up builds by mounting node modules as a volume
      - /app/node_modules
    ports:
      # Expose Vite's default port to the host
      - "5173:5173"
    env_file:
      - ./.env
    
  # ------------------------------------
  # 3. Redis (Celery Broker & Cache)
  # ------------------------------------
  redis:
    image: docker.io/redis:7-alpine # Lightweight official image
    container_name: redis_broker
    # Ports are usually unnecessary since there is no external access.
    
  # ------------------------------------
  # 4. Celery Worker (Asynchronous task processing)
  # ------------------------------------
  celery_worker:
    # Since the same Python environment as Django is required, the same build settings are reused.
    build:
      context: ./services
      dockerfile: Dockerfile.dev
    container_name: celery_worker
    # Celery Worker startup command
    command: celery -A your_project_name worker -l info 
    # Refer to Django code
    volumes:
      - ./services:/app
    env_file:
      - ./.env
    depends_on:
      - backend
      - redis

# Define volumes if data persistence is required (in this setup, the DB is SQLite and persistence is omitted)
# Since SQLite is file-based, the file will be created in the directory mounted with the code